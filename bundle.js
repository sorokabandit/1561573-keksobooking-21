(()=>{"use strict";window.debounce=function(e){let t=null;return function(...o){const n=o;t&&window.clearTimeout(t),t=setTimeout((function(){e(...n)}),500)}},(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map__overlay").getBoundingClientRect();e.addEventListener("mousedown",(function(o){o.preventDefault();let n={x:o.clientX,y:o.clientY};const r=o=>{o.preventDefault();let r=n.x-o.clientX,i=n.y-o.clientY;n={x:o.clientX,y:o.clientY},e.offsetLeft-r>=0-e.offsetWidth/2&&e.offsetLeft-r<=t.width-e.offsetWidth/2&&e.offsetTop-i>=t.top+130&&e.offsetTop-i<=t.top+630&&(e.style.top=e.offsetTop-i+"px",e.style.left=e.offsetLeft-r+"px")},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",i)}))})(),window.load=(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status&&e?e(o.response):t&&t("Статус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(()=>{t&&t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t&&t("Запрос не успел выполниться за "+o.timeout+"мс")})),o.timeout=1e4,o.open("GET","  https://21.javascript.pages.academy/keksobooking/data"),o.send()},window.save=(e,t,o)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{t(n.response)})),n.addEventListener("error",(()=>{o&&o("Произошла ошибка соединения")})),n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(e)},(()=>{const e=document.querySelector(".map");e.classList.remove("map--faded"),window.mainPin=document.querySelector(".map__pin--main");const t=document.querySelector(".ad-form"),o=document.querySelector(".map__filters");window.startMainPin=window.mainPin.getAttribute("style"),window.disabledSite=()=>{e.classList.add("map--faded"),t.classList.add("ad-form--disabled"),t.querySelectorAll("fieldset").forEach((e=>{e.setAttribute("disabled","")})),o.querySelectorAll("select").forEach((e=>{e.setAttribute("disabled","")})),o.querySelector("fieldset").setAttribute("disabled","")},document.addEventListener("DOMContentLoaded",window.disabledSite);const n=()=>{window.renderPins(window.announcements,window.countPins),e.classList.remove("map--faded"),t.classList.remove("ad-form--disabled"),t.querySelectorAll("fieldset").forEach((e=>{e.removeAttribute("disabled","")})),o.querySelectorAll("select").forEach((e=>{e.removeAttribute("disabled","")})),o.querySelector("fieldset").removeAttribute("disabled","")};window.getAddress=e=>{let t;t=e?parseFloat(parseFloat(getComputedStyle(window.mainPin).left)+.5*parseFloat(getComputedStyle(window.mainPin).width))+","+parseFloat(parseFloat(getComputedStyle(window.mainPin).top)+1.5*parseFloat(getComputedStyle(window.mainPin).height)):parseFloat(parseFloat(getComputedStyle(window.mainPin).left)+.5*parseFloat(getComputedStyle(window.mainPin).width))+","+parseFloat(parseFloat(getComputedStyle(window.mainPin).top)+.5*parseFloat(getComputedStyle(window.mainPin).height)),document.querySelector("#address").setAttribute("value",t)},window.getAddress(!1),window.mainPin.addEventListener("mouseup",(function(e){0===e.button&&(n(),window.getAddress(!0))})),window.mainPin.addEventListener("keydown",(function(e){"Enter"===e.key&&n()}))})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.announcements=[],window.renderPins=(t,o)=>{document.querySelectorAll("button.map__pin").forEach((e=>{e.classList.contains("map__pin--main")||e.remove()}));for(let n=0;n<o&&n<t.length;n++){const o=e.cloneNode(!0);o.querySelector("img").src=t[n].author.avatar,o.querySelector("img").alt=t[n].offer.title,o.style.left=t[n].location.x+"px",o.style.top=t[n].location.y+"px",document.querySelector(".map__pins").appendChild(o),o.addEventListener("click",(()=>{window.getCard(n)})),o.addEventListener("keydown",(e=>{"Enter"===e.keycode&&window.getCard(n)}))}},window.countPins=5,window.load((e=>{window.announcements=e,window.filteredAnnounements=e}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}));const t=document.querySelector(".map__filters"),o=t.querySelectorAll("select"),n=t.querySelectorAll("input[type=checkbox]"),r=()=>{const e=[],n=t.querySelectorAll("input[type=checkbox]:checked"),r=[],i={middle:[1e4,5e4],low:[0,9999],high:[50001,1e15]};o.forEach((t=>{e.push({name:t.getAttribute("name").replace("housing-",""),value:t.value})})),n.forEach((e=>{r.push(e.value)}));let d=window.announcements.filter((t=>e.every((e=>{return"price"===e.name&&"any"!==e.value?(o=t.offer.price,n=i[e.value][0],r=i[e.value][1],o>=n&&o<=r):String(t.offer[e.name])===String(e.value)||"any"===e.value;var o,n,r}))));r.length&&(d=d.filter((e=>{const t=[];return r.forEach((o=>{t.push(e.offer.features.includes(o))})),t.every((e=>!0===e))}))),window.filteredAnnounements=d,window.renderPins(d,window.countPins)};o.forEach((e=>{e.addEventListener("change",(function(){window.debounce((function(){r()}))()}))})),n.forEach((e=>{e.addEventListener("change",(()=>{window.debounce((()=>{r()}))()}))}))})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=e.querySelector(".popup__photos"),o=e=>{const o=t.querySelector(".popup__photo"),n=o.cloneNode(!0);return o.src=e,n},n=()=>{const e=document.querySelector(".map__card.popup");e&&e.remove(),document.removeEventListener("keydown",r)},r=e=>{"Escape"===e.key&&n()};window.getCard=t=>{const i=document.querySelector(".map__card.popup");i&&i.remove();const d=document.createDocumentFragment(),a=document.querySelector(".map__filters-container"),s=document.querySelector(".map"),c=window.filteredAnnounements[t];d.appendChild((t=>{const n=e.cloneNode(!0);return n.querySelector(".popup__title").textContent=t.offer.title,n.querySelector(".popup__text--address").textContent=t.offer.address,n.querySelector(".popup__text--price").textContent=t.offer.price,n.querySelector(".popup__type").textContent=t.offer.type,n.querySelector(".popup__features").textContent=t.offer.features,n.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,n.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,n.querySelector(".popup__description").textContent=t.offer.description,n.querySelector(".popup__avatar").src=t.author.avatar,n.querySelector(".popup__photos").innerHTML="",((e,t,n)=>{const r=document.createDocumentFragment();for(let n=0;n<t;n++){const t=e.offer.photos[n];r.appendChild(o(t))}n.appendChild(r)})(t,t.offer.photos.length,n.querySelector(".popup__photos")),n})(c)),document.addEventListener("keydown",r),d.querySelector(".popup__close").addEventListener("click",n),s.insertBefore(d,a)}})(),(()=>{const e=document.querySelector("#title"),t=document.querySelector("#price"),o=document.querySelector("#room_number"),n=document.querySelector("#price"),r=document.querySelector("#type"),i=document.querySelector("#timeout"),d=document.querySelector("#timein"),a=document.querySelector(".ad-form__submit"),s=document.querySelector(".ad-form"),c=document.querySelector("#success").content.querySelector(".success"),u=document.querySelector("#error").content.querySelector(".error"),l=document.querySelector(".ad-form__reset"),m={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]};let p=new class{constructor(){this.fields={name:!1,price:!1,rooms:!1}}check(){let e=!0;for(let t in this.fields)!1===this.fields[t]&&(e=!1);return e}reset(){for(let e in this.fields)this.fields.hasOwnProperty(e)&&(this.fields[e]=!1)}};e.addEventListener("input",(function(){let t=e.value.length;p.fields.name=!1,t<30?e.setCustomValidity("Ещё "+(30-t)+" симв."):t>100?e.setCustomValidity("Удалите лишние "+(t-100)+" симв."):(e.setCustomValidity(""),p.fields.name=!0),e.reportValidity()})),t.addEventListener("input",(function(){let e=t.value;p.fields.price=!1,e>1e6?t.setCustomValidity("Сумма может быть не больше 1000000"):(t.setCustomValidity(""),p.fields.price=!0),t.reportValidity()}));let f=()=>{"bungalow"===r.value?(n.setAttribute("min","0"),n.setAttribute("placeholder","0"),n.setAttribute("value","0"),n.value=0):"flat"===r.value?(n.setAttribute("min","1000"),n.setAttribute("placeholder","1000"),n.setAttribute("value","1000"),n.value=1e3):"house"===r.value?(n.setAttribute("min","5000"),n.setAttribute("placeholder","5000"),n.setAttribute("value","5000"),n.value=5e3):"palace"===r.value&&(n.setAttribute("min","10000"),n.setAttribute("placeholder","10000"),n.setAttribute("value","10000"),n.value=1e4)};f(),r.addEventListener("change",(()=>{f()})),d.addEventListener("change",(()=>{"12:00"===d.value?i.value="12:00":"13:00"===d.value?i.value="13:00":"14:00"===d.value&&(i.value="14:00")})),i.addEventListener("change",(()=>{"12:00"===i.value?d.value="12:00":"13:00"===i.value?d.value="13:00":"14:00"===i.value&&(d.value="14:00")})),o.addEventListener("change",(()=>{let e=document.querySelector("#room_number").value;p.fields.rooms=!1,Array.from(document.querySelector("#capacity").options).forEach((function(t){m[e].includes(t.value)?(t.removeAttribute("disabled"),t.setAttribute("selected",""),p.fields.rooms=!0):(t.setAttribute("disabled",""),t.removeAttribute("selected"))}))})),document.querySelector("#avatar").setAttribute("accept","image/png, image/jpeg"),document.querySelector("#images").setAttribute("accept","image/png, image/jpeg");const y=()=>{window.disabledSite();const e=c.cloneNode(!0);document.querySelector(".ad-form").appendChild(e),e.addEventListener("click",(()=>{e.remove()})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e.remove()}))},w=()=>{const e=u.cloneNode(!0);document.querySelector("main").appendChild(e),e.addEventListener("click",(()=>{e.remove()})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e.remove()}))};a.addEventListener("click",(e=>{e.preventDefault();const t=new FormData(s);if(p.check()){window.save(t,y,w),window.mainPin.setAttribute("style",window.startMainPin),window.getAddress(!1),window.disabledSite(),s.reset(),document.querySelectorAll("button.map__pin").forEach((e=>{e.classList.contains("map__pin--main")||e.remove()}));const e=document.querySelector(".ad-form-header__preview img");e.dataset.src&&(e.src=e.dataset.src);const o=document.querySelector(".ad-form__photo img");o.dataset.src&&(o.src=o.dataset.src),p.reset()}})),l.addEventListener("click",(()=>{s.reset(),window.mainPin.setAttribute("style",window.startMainPin),window.getAddress(!1);const e=document.querySelector(".ad-form-header__preview img");e.dataset.src&&(e.src=e.dataset.src);const t=document.querySelector(".ad-form__photo img");t.dataset.src&&(t.src=t.dataset.src),document.querySelectorAll("button.map__pin").forEach((e=>{e.classList.contains("map__pin--main")||e.remove()})),window.disabledSite()}))})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#avatar"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector("#images"),r=document.querySelector(".ad-form__photo img"),i=(t,o)=>{t.addEventListener("change",(function(){const n=t.files[0],r=n.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){o.setAttribute("data-src",o.src),o.src=e.result})),e.readAsDataURL(n)}}))};i(t,o),i(n,r)})()})();